<html>
<head>
<title>Lab7 </title>

<script>
// global variables
var num_rows = 16;
var num_cols = 16;
var num_mines = 40;
var tile_size = 24;
var start_time = 0;
var time_interval = 1000;
var current_time;
var remaining_flags;
var games_played = -1;
var gamestate = 0; //0 means not in play, 1 is in play, 2 is won, 3 is lost
var board = new Array(num_rows*num_cols);//Board state: -1=mine, 0=empty, 1-8=number
var visib = new Array(num_rows*num_cols);//Maintain visibility state of each tile.  0=covered, 1=empty/number, 2=flag

function debugGame()
{
  newBoard();//randomizes the board
  current_time = start_time;
  remaining_flags=num_mines;

  for (var i = 0; i < num_cols*num_rows; i++) {
    if( board[i] == -1 )
      document.images[i].src = "http://mulan.csufresno.edu/~twilson/csci130/imgs/mine.svg";
    else if( board[i] >= 0 )
      document.images[i].src = "http://mulan.csufresno.edu/~twilson/csci130/imgs/" + board[i] + ".svg";
  }
  gamestate = 1;
  update();
}
function newGame()
{
  newBoard();//randomizes the board
  current_time = start_time;
  remaining_flags=num_mines;
  games_played++;
  if( games_played == 0 )
    window.setInterval("updateTimer()",1000);
  for (var i = 0; i < num_cols*num_rows; i++) {
    document.images[i].src = "http://mulan.csufresno.edu/~twilson/csci130/imgs/tile.svg";
  }
  gamestate = 1;
  update();
}
function newBoard()
{
  for( var i = 0; i < num_rows*num_cols; i++ ) //clear board
    board[i]=0;
  for( var i = 0; i < num_mines; i++ ) //insert mines
  {
    var tempnumber = 0;
    do{
      tempnumber = Math.floor(Math.random()*(num_rows*num_cols));
    }while( board[tempnumber] == -1 )
    board[Math.floor(Math.random()*(num_rows*num_cols))] = -1;
  }
  var adjacent_bombs = 0;
  for( var i = 0; i < num_rows*num_cols; i++ ) //increment board[i] value if adjacent to a bomb
  {
    if( board[i] == -1 )
    {
      if( i%num_cols == 0 ) //along left side
      {
        if( board[i-num_cols]   != -1 ) board[i-num_cols]++; //top adjacent
        if( board[i-num_cols+1] != -1 ) board[i-num_cols+1]++; //top-right adjacent
        if( board[i+1]          != -1 ) board[i+1]++; //right adjacent
        if( board[i+num_cols+1] != -1 ) board[i+num_cols+1]++; //bottom-right adjacent
        if( board[i+num_cols]   != -1 ) board[i+num_cols]++; //bottom adjacent
      }
      else if( (i+1)%(num_cols) == 0 ) //along right side
      {
        if( board[i-num_cols-1] != -1 ) board[i-num_cols-1]++; //top-left adjacent
        if( board[i+num_cols-1] != -1 ) board[i+num_cols-1]++; //bottom-left adjacent
        if( board[i-1]          != -1 ) board[i-1]++; //left adjacent
        if( board[i+num_cols]   != -1 ) board[i+num_cols]++; //bottom adjacent
        if( board[i-num_cols]   != -1 ) board[i-num_cols]++; //top adjacent
      }
      else
      {
        if( board[i-num_cols-1] != -1 ) board[i-num_cols-1]++; //top-left adjacent
        if( board[i-num_cols+1] != -1 ) board[i-num_cols+1]++; //top-right adjacent
        if( board[i+num_cols-1] != -1 ) board[i+num_cols-1]++; //bottom-left adjacent
        if( board[i+num_cols+1] != -1 ) board[i+num_cols+1]++; //bottom-right adjacent
        if( board[i-1]          != -1 ) board[i-1]++; //left adjacent
        if( board[i+1]          != -1 ) board[i+1]++; //right adjacent
        if( board[i+num_cols]   != -1 ) board[i+num_cols]++; //bottom adjacent
        if( board[i-num_cols]   != -1 ) board[i-num_cols]++; //top adjacent
      }
    }
  }
  for( var i = 0; i < num_rows*num_cols; i++ ) //initializes the board to covered
    visib[i]=0;
}
function reveal(n) //if bomb, reveal all and end game, if number just reveal that number, if blank reveal adjacent blanks
{
  if( visib[n] == 1 ) return;
  else if( board[n] == -1 )
  {
    for( var i = 0; i < num_cols*num_rows; i++ )
    {
      if( visib[i] != 2 )
        visib[i] = 1; //reveal all tiles
    }
    gamestate = 3; //change game state to lost
  }
  else if( board[n] > 0 ) //if the tile is a number, reveal only it
    visib[n] = 1;
  else if( board[n] == 0) //then it is a blank, reveal all adjacent blanks
  {
    visib[n] = 1;
    if( n%num_cols == 0 ) //along left side
    {
      if( n != 0 ) // if not the top left corner
      {
        if( board[n-num_cols]   != -1 ) reveal(n-num_cols);   //top adjacent
        if( board[n-num_cols+1] != -1 ) reveal(n-num_cols+1); //top-right adjacent
      }
      if( n != (num_cols*num_rows)-num_cols ) // if not in the bottom left corner
      {
        if( board[n+num_cols+1] != -1 ) reveal(n+num_cols+1); //bottom-right adjacent
        if( board[n+num_cols]   != -1 ) reveal(n+num_cols);   //bottom adjacent
      }
      if( board[n+1]            != -1 ) reveal(n+1);          //right adjacent
    }
    else if( (n+1)%num_cols == 0 )                       //along right side
    {
      if( n+1 != num_cols ) // if not the top right corner
      {
        if( board[n-num_cols]   != -1 ) reveal(n-num_cols);   //top adjacent
        if( board[n-num_cols-1] != -1 ) reveal(n-num_cols-1); //top-left adjacent
      }
      if( n+1 != num_cols*num_rows ) // if not the bottom right corner
      {
        if( board[n+num_cols-1] != -1 ) reveal(n+num_cols-1); //bottom-left adjacent
        if( board[n+num_cols]   != -1 ) reveal(n+num_cols);   //bottom adjacent
      }
      if( board[n-1]            != -1 ) reveal(n-1);          //left adjacent
    }
    else
    {
      if( n+1 > num_cols ) //not on the top row
      {
        if( board[n-num_cols-1] != -1 ) reveal(n-num_cols-1); //top-left adjacent
        if( board[n-num_cols+1] != -1 ) reveal(n-num_cols+1); //top-right adjacent
        if( board[n-num_cols]   != -1 ) reveal(n-num_cols);   //top adjacent
      }
      if( n+1 < num_cols*num_rows-num_cols ) //not on the bottom row
      {
        if( board[n+num_cols-1] != -1 ) reveal(n+num_cols-1); //bottom-left adjacent
        if( board[n+num_cols+1] != -1 ) reveal(n+num_cols+1); //bottom-right adjacent
        if( board[n+num_cols]   != -1 ) reveal(n+num_cols);   //bottom adjacent
      }
      if( board[n-1]            != -1 ) reveal(n-1);          //left adjacent
      if( board[n+1]            != -1 ) reveal(n+1);          //right adjacent
    }
  }
  update();
}

function leftClick(n) { //had to change this from click for some reason
  if( visib[n] == 0 && gamestate == 1 )
    reveal(n);
  else return false;
}
function rightClick(n)
{
  if( visib[n] == 2 )
  {
    visib[n] = 0;
    remaining_flags++;
  }
  else if( visib[n] == 0 && remaining_flags > 0 )
  {
    visib[n] = 2;
    remaining_flags--;
  }
  else return false;
  update();
}
function update() { // update() refreshes values displayed in textboxes
  document.f.flags.value = remaining_flags;
  document.f.gamenumber.value = games_played;
  for (var i = 0; i < num_cols*num_rows; i++) {
    if( gamestate == 3 && board[i] != -1 && visib[i] == 2 )
    {
      document.images[i].src = "http://mulan.csufresno.edu/~twilson/csci130/imgs/xflag.svg";
    }
    else if( visib[i] == 1 ) //revealed blank or number
    {
      if( board[i] == -1 ) //reveal the mine because the game was lost
      {
        document.images[i].src = "http://mulan.csufresno.edu/~twilson/csci130/imgs/mine.svg";
        gamestate = 3; //change game state to "lost"
      }
      else
      {
        document.images[i].src = "http://mulan.csufresno.edu/~twilson/csci130/imgs/" + board[i] + ".svg";
      }
    }
    else if( visib[i] == 2 ) //flag
    {
      document.images[i].src = "http://mulan.csufresno.edu/~twilson/csci130/imgs/flag.svg";
    }
    else if( visib[i] == 0 ) //recover if needed
      document.images[i].src = "http://mulan.csufresno.edu/~twilson/csci130/imgs/tile.svg";
  }
  checkGame();
}

function checkGame()
{
  if( gamestate == 3 ) //loss condition
  {
    alert("Sorry, you have lost.");
    return;
  }
  for( var i = 0; i < num_cols*num_rows; i++ )
  {
    if( visib[i] == 0 ) //if there is a covered non flagged square left, no win
      return;
    if( board[i] == -1 && visib[i] != 2 ) //unflagged bomb
      return;
  }
  if( remaining_flags != 0 ) return;
  else
  {
    gamestate = 2; //won
    alert("Congratulations, you have won.");
  }
}

function gameGrid()
{
  document.write("<table border='1'>");
  for( var i=0; i<num_cols; i++ )
  {
    document.write("<tr>");
    for( var j=0; j<num_rows; j++ )
    {
      document.write("<td><a HREF='' onContextMenu='rightClick(", j+num_cols*i, "); return false' onClick='leftClick(", j+num_cols*i, "); return false'> <img SRC='http://mulan.csufresno.edu/~twilson/csci130/imgs/tile.svg' WIDTH='", tile_size, "' HEIGHT='", tile_size, "'></a></td>");
    }
    document.write("</tr>");
  }
  document.write("</table>");
}

function timerInit()
{
  updateTimer();
  window.setInterval("updateTimer()",1000);
}

function updateTimer()
{
  current_time++;
  document.f.timer.value = current_time;
}
</script>


</head>
<body>
  <script>
    gameGrid();
  </script>
  <br>
  <form NAME='f'>
    <input TYPE='button' VALUE='Debug' onClick='debugGame()'>
    <input TYPE='button' VALUE='New Game' onClick='newGame()'>
    &nbsp;&nbsp;&nbsp;&nbsp;
    Flags:<input TYPE='text' NAME='flags' SIZE='3'>
    &nbsp;&nbsp;&nbsp;&nbsp;
    Time:<input TYPE='text' NAME='timer' SIZE='3'>
    &nbsp;&nbsp;&nbsp;&nbsp;
    Game:<input TYPE='text' NAME='gamenumber' SIZE='3'>
  </form>
  <br>
</body>
</html>


















